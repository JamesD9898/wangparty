<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WangParty</title>
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <header>
      <nav class="navbar">
        <a href="#" class="logo">WangParty</a>
        <ul class="nav-links">
          <li><a href="#">Home</a></li>
          <li><a href="#">Join Lobby</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <div class="modal" id="create-server-modal">
        <div class="modal-content">
          <h2>Create Server</h2>
          <input type="text" id="server-name" placeholder="Server Name" />
          <button id="create-server-button">Create</button>
        </div>
      </div>
      <section>
        <h3>5-Second Rule</h3>
        <p>
          How to Play: Join with friends. Input questions, vote on answers. The
          most knowledgeable and quick-thinking person wins!
        </p>
      </section>

      <section class="name-input">
        <h3>Display Name: <span id="display-name"></span></h3>
        <label for="username">Enter your name (optional):</label>
        <div class="input-group">
          <input type="text" id="username" placeholder="ex. Alex Kovalenko" />
          <button id="update-name-button">Update</button>
        </div>
      </section>
      <script>
        // Cookie utility functions
        function getCookieValue(name) {
          const regex = new RegExp(`(^| )${name}=([^;]+)`);
          const match = document.cookie.match(regex);
          if (match) {
            return decodeURIComponent(match[2]);
          }
          return null;
        }

        function setCookie(name, value, days = 30) {
          const expires = new Date();
          expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
          document.cookie = `${name}=${encodeURIComponent(
            value
          )};expires=${expires.toUTCString()};path=/`;
        }

        // Initialize display name
        function initializeDisplayName() {
          let name = getCookieValue("name");
          if (!name) {
            const guestName = "Guest" + Math.round(Math.random() * 1000000);
            setCookie("name", guestName);
            name = guestName;
          }

          const displayName = document.getElementById("display-name");
          displayName.textContent = name;

          // Set the input field to current name for easy editing
          const usernameInput = document.getElementById("username");
          usernameInput.value = name;
        }

        // Update name functionality
        function updateDisplayName() {
          const usernameInput = document.getElementById("username");
          const newName = usernameInput.value.trim();

          if (newName && newName.length > 0) {
            setCookie("name", newName);
            const displayName = document.getElementById("display-name");
            displayName.textContent = newName;

            // Show success feedback
            const button = document.getElementById("update-name-button");
            const originalText = button.textContent;
            button.textContent = "Updated!";
            button.style.background =
              "linear-gradient(135deg, #38a169 0%, #2f855a 100%)";

            setTimeout(() => {
              button.textContent = originalText;
              button.style.background =
                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
            }, 2000);
          } else {
            // Show error feedback
            const button = document.getElementById("update-name-button");
            const originalText = button.textContent;
            button.textContent = "Enter name!";
            button.style.background =
              "linear-gradient(135deg, #dc3545 0%, #c82333 100%)";

            setTimeout(() => {
              button.textContent = originalText;
              button.style.background =
                "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
            }, 2000);
          }
        }

        // Event listeners
        document
          .getElementById("update-name-button")
          .addEventListener("click", updateDisplayName);

        // Allow Enter key to update name
        document
          .getElementById("username")
          .addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
              updateDisplayName();
            }
          });

        // Initialize on page load
        initializeDisplayName();
      </script>

      <section>
        <h3>Servers</h3>
        <button class="create-server">Create Server</button>

        <div class="servers"></div>
      </section>
    </main>

    <script>
      const serverdiv = document.querySelector(".servers");

      function handleJoinLobby() {
        // Use the current name from cookie (already updated by the update button)
        const currentName = getCookieValue("name");
        if (currentName) {
          // Cookie is already set, just redirect
          window.location.href = "/game/game.html";
        } else {
          // Fallback - set a guest name
          const guestName = "Guest" + Math.round(Math.random() * 1000000);
          setCookie("name", guestName);
          window.location.href = "/game/game.html";
        }
      }

      async function updateServerDiv() {
        const servers = await fetch("/api/servers").then((res) => res.json());
        let serverhtml = "";
        servers.servers.forEach((server) => {
          serverhtml += `
            <div class="server" id="server${server.id}">
              <h3 class="servername">${server.name}</h3>
              <p class="visibility ${server.public ? "public" : "private"}">
                ${server.public ? "Public" : "Private"}
              </p>
              <p class="players">${server.players.length}/5 Players</p>
              <button class="join" data-server-id="${
                server.id
              }">Join Lobby</button>
            </div>`;
        });

        serverdiv.innerHTML = serverhtml ? serverhtml : "No servers found";

        // Add event listeners to all join buttons
        const joinButtons = document.querySelectorAll(".join");
        joinButtons.forEach((button) => {
          button.addEventListener("click", handleJoinLobby);
        });
      }

      updateServerDiv();

      async function join(name) {
        try {
          const response = await fetch("/api/join", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name: name }),
          });
        } catch (error) {
          console.error("Failed to join:" + error);
          //redirect to home page
        }
      }
    </script>
  </body>
</html>
